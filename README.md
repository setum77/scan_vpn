# SKAN_VPN

**skan_vpn** - Утилита сканирующая VPN сеть организации, а именно, подключенные роутеры и важные устройства за ним. Это мой первый серьезный проект на Python. Путь развития:

- скрипт на Python в терминале, запуск в ручную, отправка письма после сканирования
- настройка автозапуска с расписанием на Cron в Debian
- вывод в HTML результатов сканирования
- подключение YAML для хранения информации по роутерам и устройствам
- погружение в SQL
- переход на Flask и соответственно DB SQLite
- освоение GIT и GitHub, их активное использование

## Возможности

- Хранение данных - результаты сканирования хранятся в DB SQLite.
- Вывод результатов - в веб-интерфейсе с разбивкой по отделам организации (офисам), выводятся последние 24 часа, если щелкнуть по заголовку с временем, откроется окно с промежуточными результатами за выбранный час. Можно посмотреть результаты сканирования за конкретные сутки.
- Уведомление по электронной почте - в случае пропажи роутера или устройства со связи, или ноаоборт, появление устройства в сети VPN, после отсутствия, формируются и отправляются письма администратору сети. По обычным (стационарным) роутерам и устройствам письма отправляются сразу после сканирования, по мобильным роутерам и устройствам раз в сутки в 7:00 утра.
- Ведение логов - в веб-интерфейсе есть возможность просматривать логи (последние 500 строк)
- Чистка логов - в файле логов `monitor2.log` хранится информация за последние 45 дней. Файл очищается 1 числа каждого месяца.

## Скриншоты

- Скриншоты с работой программы можно посмотреть на Вики https://github.com/setum77/scan_vpn/wiki/Скриншоты

## Принцип работы

БД содержит информацию по роутерам (таблица `routers`) и устройствам за ними (таблица `devices`).

Пингуются указаные VPN-IP роутеров, проверяется доступность DNS имени если имеется, пингуется внутренний IP роутера.

Если пинги прошли успешно, запускается сканирование устройств за роутером, в зависимости от класса устройства проверка проходит через открытие порта или пингом.

Результаты записываются в БД (sqlite).

По результатам сканирования формируются письма оповещения в случае, если роутер или устройство пропало со связи, или наоборот появилась связь.

Роутеры могут быть стационарные и мобильные, по стационарным роутерам письма оповещения отправляются сразу после сканирования, по мобильным роутерам формируется общая статистика за сутки и письмо отправляется в 7 утра.

Сканирование запускается каждые 5 минут. Результаты сканирования выводятся на html страницу.

## БД

Используется sqlite, в базе данных три таблицы: “routers” – информация по роутерам, “devices” – информация по устройствам, “scan_logs” – с результатами сканирования.

Для организации VPN подразумевается использование протоколов L2TP/IPsec и SSTP (но это не важно), под vpn-IP выделены два поля ip1 и ip2 соответственно. В поле ip3 хранится ip адрес внутренний сети, в поле dns доменное имя роутера. В поля lan1, lan2, lan3, lan4 записываются последние статусы по ip1, ip2, ip3, vpn соответственно, могут принимать значения 0 – не в сети, 1 – в сети, 2 – не сканировался. Нужны для формирования таблицы scan_logs.

В случае если lan4 принимает значение 0, в поле lan4err записывается цифровой код ошибки. На запущенном сервере, на главной странице с результатами эти коды отображаются в строке - DNS. На странице «Инструменты» можно посмотреть расшифровку кодов.

## Веб сервер

Используется Flask. Доступен на порту 5002. Исполняемый файл flask_db.py, в нем свой планировщик: запуск сканирования каждые 5 мин., запуск чистки логов (требует доработки) 1 числа каждого месяца, очищаются записи старше 45 дней, запуск чистки БД (пока не реализовал) 1 числа каждого года, очищается журнал сканирования старше 1,5 года.

## Требования:

1. Устанавленный Python
2. Рекомендую установить Git
3. Рекомендую установить uv

## Установка

1. Будем устанавливать в корневую папку пользователя

```bash
cd ~
git clone https://github.com/setum77/scan_vpn.git
```

2. Перейдем в созданную папку и посмотрим содержимое

```bash
cd scan_vpn
ls -la
```

3. Установим виртуальное окружение и установим зависимости

```bash
uv venv
uv pip install -r requirements.txt
```

4. Подготовить БД. Я работал с БД на машине с Windows программе DB Browser for SQLite

   a. Создать копию `routers_bckp.db`, затем копию переименовать в `routers.db`
   b. Открыть `routers.db` для редактирования, в DB Browser for SQLite.
   c. Заполнить таблицы `routers` и `devices`
   d. Залить БД в рабочую папку сервера ~/scan_vpn

5. Подготовить файл .env. Открыть его и заполнить необходимые данные:

   ```bash
   cp .env_bckp .env
   nano .env
   ```

   **пояснение**

   отправка писем настроена через SMTP сервер, через 465 порт. Если ваша почта работает на 25 порту (`smtp.starttls()`) редактиреум код в файле `scan_to_db.py` в функции `send_notification_email` (там есть пояснения)

   - SENDER_EMAIL- почта отправителя
   - SENDER_PASSWORD - пароль от почты для внешнего приложения
   - TO_EMAIL адрес получателя
   - CC_EMAIL адреса для копий, через запятую

6. Добавить права на исполнение на все файлы `*.py` и `*.sh` (`chmod +x ...`)

   ```bash
   chmod +x run_flask_db.sh
   chmod +x scan_port.py
   chmod +x scan_to_db.py
   chmod +x flask_db.py
   ```

7. запустить из uv для проверки и отладки

```bash
uv run flask_db.py
```

Остановить процесс комбинация клавиш Ctrl+C

8. Настроить планировщик (cron) на запуск Веб сервера.

```bash
nano run_flask_db.sh
```

Редактируем с учетом подсказок

```ini
#!/bin/bash

# Переход в директорию проекта (!!!заменить user-name на свое)
cd /home/user-name/scan_vpn

# Если не используем uv, то активируем виртуальное окружение (раскомитить две строки ниже,
# поправивить название папки .venv, если нужно,
# закомитить строку "/home/user-name/.local/bin/uv run -- python flask_db.py")
# source .venv/bin/activate
# exec python -m scan_vpn.flask_db

# Запуск приложения через uv (!!!заменить user-name на свое)
/home/user-name/.local/bin/uv run -- python flask_db.py
```

Открыть crontab

```bash
crontab -e
```

Спросит в каком редакторе открыть, выбрать редактор

Спуститься на пустую строку, если есть другие задания и добавьте строку для запуска при загрузке системы (!!!поменять в двух местах user-name на свой):

```ini
@reboot /home/user-name/scan_vpn/run_flask_db.sh >> /home/user-name/scan_vpn/cron.log 2>&1
```
